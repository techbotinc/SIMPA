<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIMPA</title>
    
    <!-- Tailwind CSS for Modern Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons for modern SVG icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbar for clean look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Smooth slide up animation for modal */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-animate {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Glassmorphism effects */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#10B981', // Emerald 500
                        danger: '#EF4444', // Red 500
                        dark: '#111827',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Top Header & Balance Card -->
    <header class="flex-none p-6 pb-8 bg-primary text-white rounded-b-[2rem] shadow-lg z-10 relative">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-lg tracking-wider">SIMPA</span>
        </div>
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-sm font-medium opacity-80">Total Balance</h1>
                <h2 class="text-3xl font-bold mt-1" id="totalBalance">Rs. 0</h2>
            </div>
            <div class="h-10 w-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm cursor-pointer hover:bg-white/30 transition" onclick="confirmResetData()">
                <i class="ph ph-trash text-xl"></i>
            </div>
        </div>

        <!-- Income vs Expense Cards -->
        <div class="flex gap-4">
            <div class="flex-1 bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/10">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-6 h-6 rounded-full bg-emerald-400/20 flex items-center justify-center text-emerald-300">
                        <i class="ph ph-arrow-down-left"></i>
                    </div>
                    <span class="text-xs font-medium text-emerald-100">Income</span>
                </div>
                <p class="text-lg font-semibold text-white" id="totalIncome">Rs. 0</p>
            </div>
            <div class="flex-1 bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/10">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-6 h-6 rounded-full bg-rose-400/20 flex items-center justify-center text-rose-300">
                        <i class="ph ph-arrow-up-right"></i>
                    </div>
                    <span class="text-xs font-medium text-rose-100">Expense</span>
                </div>
                <p class="text-lg font-semibold text-white" id="totalExpense">Rs. 0</p>
            </div>
        </div>
    </header>

    <!-- Main Content Area: Transactions List -->
    <main class="flex-1 overflow-y-auto p-5 pb-24 no-scrollbar relative -top-4">
        <div class="flex justify-between items-center mb-4 px-1">
            <h3 class="font-bold text-gray-700 text-lg">Recent Transactions</h3>
            <!-- Placeholder button: Removed functionality as requested -->
            <button onclick="console.log('View All clicked')" class="text-sm text-primary font-medium">View All</button>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex-col items-center justify-center py-10 opacity-50">
            <i class="ph ph-receipt text-6xl mb-3 text-gray-400"></i>
            <p class="text-gray-500 text-sm">No transactions yet.</p>
        </div>

        <!-- List Container -->
        <div id="transactionList" class="space-y-3">
            <!-- Transactions will be injected here via JS -->
        </div>
    </main>

    <!-- Floating Action Button (FAB) -->
    <div class="fixed bottom-6 right-6 z-30">
        <button onclick="openModal()" class="h-14 w-14 bg-primary text-white rounded-full shadow-xl shadow-indigo-500/40 flex items-center justify-center transform transition active:scale-95 hover:bg-indigo-700">
            <i class="ph ph-plus text-2xl font-bold"></i>
        </button>
    </div>

    <!-- Add Transaction Modal (Overlay) -->
    <div id="transactionModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        
        <!-- Modal Content -->
        <div class="absolute bottom-0 w-full bg-white rounded-t-[2rem] p-6 modal-animate shadow-2xl h-[85vh] flex flex-col">
            <div class="flex justify-center mb-4">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Add Transaction</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>

            <form id="addForm" class="flex-1 flex flex-col gap-5 overflow-y-auto no-scrollbar pb-10">
                
                <!-- Amount Input -->
                <div class="relative">
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 block">Amount</label>
                    <div class="flex items-end border-b-2 border-gray-200 focus-within:border-primary py-2 transition-colors">
                        <span class="text-2xl font-bold text-gray-400 mr-2">Rs.</span>
                        <input type="number" id="amount" class="w-full text-4xl font-bold text-gray-800 bg-transparent outline-none placeholder-gray-300" placeholder="0" required inputmode="numeric">
                    </div>
                </div>

                <!-- Date & Time Input -->
                <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 block">Date & Time</label>
                    <input type="datetime-local" id="dateInput" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary transition font-medium text-gray-700">
                </div>

                <!-- Transaction Type Toggle -->
                <div class="bg-gray-100 p-1 rounded-xl flex">
                    <button type="button" class="flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-rose-500" id="btnExpense" onclick="setType('expense')">
                        Expense
                    </button>
                    <button type="button" class="flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:text-emerald-600" id="btnIncome" onclick="setType('income')">
                        Income
                    </button>
                </div>
                <input type="hidden" id="type" value="expense">

                <!-- Account Selection (Cash, Bank, etc) -->
                <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 block">Payment Method</label>
                    <div class="grid grid-cols-2 gap-3" id="accountGrid">
                        <!-- Injected by JS -->
                    </div>
                    <input type="hidden" id="account" value="Cash">
                </div>

                <!-- Category Selection -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Category</label>
                        <button type="button" onclick="addNewCategoryPrompt()" class="text-xs text-primary font-bold flex items-center gap-1">
                            <i class="ph ph-plus"></i> Add New
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2" id="categoryList">
                        <!-- Injected by JS -->
                    </div>
                    <input type="hidden" id="category" value="General">
                </div>

                <!-- Description -->
                <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 block">Note</label>
                    <input type="text" id="note" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary transition" placeholder="What is this for?">
                </div>

                <div class="mt-auto pt-4">
                    <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-indigo-500/30 active:scale-[0.98] transition-transform">
                        Save Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Dialog Modal for Confirm/Prompt -->
    <div id="customDialogModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity" onclick="hideCustomDialog()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-6">
            <div class="bg-white rounded-2xl p-6 shadow-2xl w-full max-w-sm transform scale-95 transition-all">
                <h3 id="dialogTitle" class="text-xl font-bold text-gray-800 mb-2"></h3>
                <p id="dialogMessage" class="text-sm text-gray-600 mb-4"></p>
                
                <input type="text" id="dialogInput" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:border-primary hidden mb-4" placeholder="Enter text here...">

                <div class="flex justify-end gap-3">
                    <button id="dialogCancelBtn" onclick="hideCustomDialog()" class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition">
                        Cancel
                    </button>
                    <button id="dialogConfirmBtn" class="px-4 py-2 text-sm font-medium text-white rounded-lg bg-primary shadow-md shadow-indigo-500/30 active:scale-95 transition">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const defaultAccounts = [
            { id: 'acc1', name: 'Cash', icon: 'ph-money' },
            { id: 'acc2', name: 'Bank', icon: 'ph-bank' },
            { id: 'acc3', name: 'Digi Wallet', icon: 'ph-wallet' },
            { id: 'acc4', name: 'Loan', icon: 'ph-hand-coins' }
        ];

        const defaultCategories = [
            'Grocery', 'Bills', 'Personal', 'Food', 'Transport', 'Shopping', 'Health', 'Education'
        ];

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || defaultCategories;

        // --- DOM Elements ---
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('dateInput');
        const noteInput = document.getElementById('note');
        const typeInput = document.getElementById('type');
        const accountInput = document.getElementById('account');
        const categoryInput = document.getElementById('category');
        const modal = document.getElementById('transactionModal');
        
        // Custom Dialog Elements
        const dialogModal = document.getElementById('customDialogModal');
        const dialogTitle = document.getElementById('dialogTitle');
        const dialogMessage = document.getElementById('dialogMessage');
        const dialogInput = document.getElementById('dialogInput');
        const dialogConfirmBtn = document.getElementById('dialogConfirmBtn');
        const dialogCancelBtn = document.getElementById('dialogCancelBtn');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderAccounts();
            // Ensure a category is selected if none is present (fixes initial bug if localStorage was empty)
            if (!categoryInput.value || categories.length === 0) {
                categoryInput.value = defaultCategories[0] || 'General';
                if (categories.length === 0) categories = defaultCategories;
            }
            renderCategories();
            updateUI();
        });

        // --- Core Logic ---

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('categories', JSON.stringify(categories));
            updateUI();
        }

        function updateUI() {
            renderTransactions();
            calculateTotals();
        }

        function calculateTotals() {
            let total = 0;
            let income = 0;
            let expense = 0;

            transactions.forEach(t => {
                const amt = parseFloat(t.amount);
                if (t.type === 'income') {
                    income += amt;
                    total += amt;
                } else {
                    expense += amt;
                    total -= amt;
                }
            });

            document.getElementById('totalBalance').innerText = formatCurrency(total);
            document.getElementById('totalIncome').innerText = formatCurrency(income);
            document.getElementById('totalExpense').innerText = formatCurrency(expense);
        }

        function formatCurrency(num) {
            // Use Intl.NumberFormat for proper Indian Rupee formatting (Rs.)
            const formatter = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            });
            return formatter.format(num).replace('â‚¹', 'Rs. ');
        }

        // --- Render Functions ---

        function renderAccounts() {
            const grid = document.getElementById('accountGrid');
            grid.innerHTML = '';
            defaultAccounts.forEach(acc => {
                const isSelected = accountInput.value === acc.name;
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl border flex items-center gap-2 cursor-pointer transition-all ${isSelected ? 'border-primary bg-indigo-50 text-primary' : 'border-gray-200 bg-white text-gray-600 hover:border-gray-300'}`;
                div.onclick = () => selectAccount(acc.name);
                div.innerHTML = `
                    <i class="ph ${acc.icon} text-lg"></i>
                    <span class="text-sm font-medium">${acc.name}</span>
                `;
                grid.appendChild(div);
            });
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            categories.forEach(cat => {
                const isSelected = categoryInput.value === cat;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `px-4 py-2 rounded-full text-xs font-medium border transition-all ${isSelected ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-400'}`;
                btn.innerText = cat;
                btn.onclick = () => selectCategory(cat);
                list.appendChild(btn);
            });
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            const emptyState = document.getElementById('emptyState');
            list.innerHTML = '';

            if (transactions.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                return;
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
            }

            // Sort by isoDate (newest first)
            const sorted = [...transactions].sort((a, b) => {
                const dateA = a.isoDate ? new Date(a.isoDate) : new Date(a.id);
                const dateB = b.isoDate ? new Date(b.isoDate) : new Date(b.id);
                return dateB - dateA;
            });

            sorted.forEach((t) => {
                const isIncome = t.type === 'income';
                const el = document.createElement('div');
                el.className = 'bg-white rounded-2xl p-4 shadow-sm flex justify-between items-center border border-gray-100';
                
                // Icon based on type
                const iconBg = isIncome ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-500';
                const iconClass = isIncome ? 'ph-arrow-down-left' : 'ph-arrow-up-right';

                // Display Note if exists, otherwise show category or account
                const subText = t.note ? t.note : t.account;

                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full ${iconBg} flex items-center justify-center flex-shrink-0">
                            <i class="ph ${iconClass} text-lg"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800 text-sm">${t.category}</p>
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                                <span>${t.account}</span>
                                <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                                <span class="truncate max-w-[100px]">${subText}</span>
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${isIncome ? 'text-emerald-600' : 'text-rose-500'}">${isIncome ? '+' : '-'} ${formatCurrency(t.amount)}</p>
                        <div class="flex flex-col items-end">
                            <span class="text-[10px] text-gray-400 mt-0.5">${t.date}</span>
                            <button onclick="confirmDeleteTransaction(${t.id})" class="text-xs text-gray-300 hover:text-red-500 mt-1 p-1">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- Interaction Handlers ---

        function setType(type) {
            typeInput.value = type;
            const btnExpense = document.getElementById('btnExpense');
            const btnIncome = document.getElementById('btnIncome');

            if (type === 'expense') {
                btnExpense.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-rose-500";
                btnIncome.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:text-emerald-600";
            } else {
                btnIncome.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-emerald-600";
                btnExpense.className = "flex-1 py-2.5 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:text-rose-500";
            }
        }

        function selectAccount(name) {
            accountInput.value = name;
            renderAccounts();
        }

        function selectCategory(name) {
            categoryInput.value = name;
            renderCategories();
        }

        function addNewCategoryPrompt() {
            showCustomDialog({
                title: "Add New Category",
                message: "Please enter the name for your new category.",
                type: 'input',
                placeholder: 'e.g., Entertainment',
                onConfirm: (newCat) => {
                    if (newCat && newCat.trim() !== "") {
                        categories.push(newCat.trim());
                        selectCategory(newCat.trim());
                        saveData();
                    }
                }
            });
        }

        function confirmDeleteTransaction(id) {
            showCustomDialog({
                title: "Confirm Deletion",
                message: "Are you sure you want to permanently delete this transaction?",
                type: 'confirm',
                onConfirm: () => {
                    deleteTransaction(id);
                }
            });
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
        }

        function confirmResetData() {
            showCustomDialog({
                title: "Reset All Data",
                message: "WARNING: This will delete ALL your transactions and custom categories. This action cannot be undone.",
                type: 'confirm',
                onConfirm: () => {
                    localStorage.removeItem('transactions');
                    localStorage.removeItem('categories');
                    transactions = [];
                    categories = defaultCategories;
                    categoryInput.value = defaultCategories[0];
                    renderCategories();
                    updateUI();
                },
                confirmText: 'Yes, Reset',
                confirmColor: 'bg-danger shadow-red-500/30'
            });
        }

        // --- Modal Logic ---

        function openModal() {
            modal.classList.remove('hidden');
            
            // Set default date to now (local time)
            const now = new Date();
            // Use UTC offset to correctly format the local time for input type="datetime-local"
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dateInput.value = now.toISOString().slice(0, 16);

            amountInput.focus();
        }

        function closeModal() {
            modal.classList.add('hidden');
            // Reset form
            document.getElementById('addForm').reset();
            setType('expense');
            accountInput.value = 'Cash';
            renderAccounts();
            categoryInput.value = (categories.length > 0) ? categories[0] : 'General';
            renderCategories();
        }

        // --- Custom Dialog Logic ---

        let currentConfirmCallback = null;
        let currentCancelCallback = null;

        function showCustomDialog({ title, message, type = 'confirm', placeholder = '', onConfirm, onCancel }) {
            dialogTitle.innerText = title;
            dialogMessage.innerText = message;
            
            dialogConfirmBtn.classList.remove('bg-danger', 'shadow-red-500/30');
            dialogConfirmBtn.classList.add('bg-primary', 'shadow-indigo-500/30');
            dialogConfirmBtn.innerText = 'Confirm';
            dialogCancelBtn.innerText = 'Cancel';

            dialogInput.value = '';
            
            if (type === 'input') {
                dialogInput.classList.remove('hidden');
                dialogInput.placeholder = placeholder;
                dialogConfirmBtn.innerText = 'Submit';
            } else {
                dialogInput.classList.add('hidden');
            }

            if (onConfirm) {
                currentConfirmCallback = onConfirm;
            }
            if (onCancel) {
                currentCancelCallback = onCancel;
            }

            dialogModal.classList.remove('hidden');
        }

        function hideCustomDialog() {
            dialogModal.classList.add('hidden');
            currentConfirmCallback = null;
            currentCancelCallback = null;
        }

        dialogCancelBtn.onclick = () => {
            hideCustomDialog();
            if (currentCancelCallback) currentCancelCallback();
        };

        dialogConfirmBtn.onclick = () => {
            const isInput = !dialogInput.classList.contains('hidden');
            let result = isInput ? dialogInput.value.trim() : true;

            hideCustomDialog();
            if (currentConfirmCallback) {
                if (isInput) {
                    currentConfirmCallback(result);
                } else {
                    currentConfirmCallback();
                }
            }
        };


        // --- Form Submission ---

        document.getElementById('addForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) {
                console.error("Invalid amount entered.");
                return;
            }

            // Correctly handle Date from datetime-local input
            const dateValue = dateInput.value;
            // Since dateValue lacks timezone info, we treat it as local time.
            const selectedDate = new Date(dateValue);

            const newTx = {
                id: Date.now(),
                amount: amount,
                type: typeInput.value,
                account: accountInput.value,
                category: categoryInput.value || 'General',
                note: noteInput.value,
                isoDate: selectedDate.toISOString(), // Stored for sorting
                date: selectedDate.toLocaleDateString('en-IN', { 
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                }) // Stored for display
            };

            transactions.push(newTx);
            saveData();
            closeModal();
        });

    </script>
</body>
</html>
